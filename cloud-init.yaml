#cloud-config
package_update: true
package_upgrade: true

packages:
  - podman-compose
  - git
  - rclone
  - gnupg

users:
  - name: deploy
    groups: [wheel]
    sudo: ["ALL=(ALL) NOPASSWD:ALL"]
    shell: /bin/bash
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAICkOhxkw7DF9PYJep6cSBBpvqMWjVZZYKl8ZrLAaBV9i yearofbingo-ci

ssh_pwauth: false
disable_root: true

mounts:
  - [/dev/sdb, /mnt/data, ext4, "defaults,nofail", "0", "2"]

write_files:
  # Allow unprivileged ports from 80
  - path: /etc/sysctl.d/99-unprivileged-ports.conf
    content: |
      net.ipv4.ip_unprivileged_port_start=80

  # Cloudflare tunnel service
  - path: /etc/systemd/system/cloudflared.service
    content: |
      [Unit]
      Description=Cloudflare Tunnel
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=simple
      User=deploy
      ExecStart=/usr/local/bin/cloudflared tunnel run yearofbingo
      Restart=always
      RestartSec=5

      [Install]
      WantedBy=multi-user.target

  # Cloudflare tunnel config
  # Note: credentials-file uses tunnel UUID. Get this from:
  # cloudflared tunnel list
  - path: /home/deploy/.cloudflared/config.yml
    owner: deploy:deploy
    permissions: "0600"
    content: |
      tunnel: yearofbingo
      credentials-file: /home/deploy/.cloudflared/6858ee6a-fee0-4d96-8e20-8f4c7351c57b.json

      ingress:
        - hostname: yearofbingo.com
          service: http://localhost:80
        - hostname: ssh.yearofbingo.com
          service: ssh://localhost:22
        - service: http_status:404

  # Backup service (runs daily)
  - path: /etc/systemd/system/yearofbingo-backup.service
    content: |
      [Unit]
      Description=Year of Bingo Database Backup
      After=network-online.target yearofbingo.service
      Wants=network-online.target

      [Service]
      Type=oneshot
      User=deploy
      WorkingDirectory=/opt/yearofbingo
      ExecStart=/opt/yearofbingo/scripts/backup.sh
      StandardOutput=journal
      StandardError=journal

  # Backup timer (daily at 3 AM)
  - path: /etc/systemd/system/yearofbingo-backup.timer
    content: |
      [Unit]
      Description=Daily backup for Year of Bingo

      [Timer]
      OnCalendar=*-*-* 03:00:00
      RandomizedDelaySec=900
      Persistent=true

      [Install]
      WantedBy=timers.target

  # Backup verification service (runs daily after backup)
  - path: /etc/systemd/system/yearofbingo-verify-backup.service
    content: |
      [Unit]
      Description=Year of Bingo Backup Verification
      After=network-online.target yearofbingo-backup.service
      Wants=network-online.target

      [Service]
      Type=oneshot
      User=deploy
      WorkingDirectory=/opt/yearofbingo
      ExecStart=/opt/yearofbingo/scripts/verify-backup.sh
      StandardOutput=journal
      StandardError=journal

  # Backup verification timer (daily at 4 AM, after 3 AM backup)
  - path: /etc/systemd/system/yearofbingo-verify-backup.timer
    content: |
      [Unit]
      Description=Daily backup verification for Year of Bingo

      [Timer]
      OnCalendar=*-*-* 04:00:00
      RandomizedDelaySec=900
      Persistent=true

      [Install]
      WantedBy=timers.target

  # Rclone config for Cloudflare R2
  # Note: Update with your actual R2 credentials
  - path: /home/deploy/.config/rclone/rclone.conf
    owner: deploy:deploy
    permissions: "0600"
    content: |
      [r2]
      type = s3
      provider = Cloudflare
      access_key_id = YOUR_R2_ACCESS_KEY_ID
      secret_access_key = YOUR_R2_SECRET_ACCESS_KEY
      endpoint = https://YOUR_ACCOUNT_ID.r2.cloudflarestorage.com
      acl = private
      no_check_bucket = true

  # App service (starts podman-compose on boot)
  - path: /etc/systemd/system/yearofbingo.service
    content: |
      [Unit]
      Description=Year of Bingo App
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      User=deploy
      WorkingDirectory=/opt/yearofbingo
      ExecStart=/usr/bin/podman-compose up -d
      ExecStop=/usr/bin/podman-compose down

      [Install]
      WantedBy=multi-user.target

runcmd:
  # Format volume if not already formatted
  - |
    if ! blkid /dev/sdb; then
      mkfs.ext4 /dev/sdb
    fi
  - mount -a

  # Create data directories
  - mkdir -p /mnt/data/postgres /mnt/data/redis
  - chown -R deploy:deploy /mnt/data
  - chmod 700 /mnt/data/postgres /mnt/data/redis

  # Apply sysctl settings
  - sysctl -p /etc/sysctl.d/99-unprivileged-ports.conf

  # Enable lingering for rootless podman
  - loginctl enable-linger deploy

  # Firewall (HTTP/HTTPS for direct access, can be removed if tunnel-only)
  - firewall-cmd --permanent --add-service=http
  - firewall-cmd --permanent --add-service=https
  - firewall-cmd --reload

  # Create app directory
  - mkdir -p /opt/yearofbingo
  - chown deploy:deploy /opt/yearofbingo

  # Install cloudflared
  - curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o /usr/local/bin/cloudflared
  - chmod +x /usr/local/bin/cloudflared

  # Create .cloudflared directory
  - mkdir -p /home/deploy/.cloudflared
  - chown -R deploy:deploy /home/deploy/.cloudflared

  # Create rclone config directory
  - mkdir -p /home/deploy/.config/rclone
  - chown -R deploy:deploy /home/deploy/.config

  # Enable the app service
  - systemctl daemon-reload
  - systemctl enable yearofbingo.service

  # Enable backup and verification timers
  - systemctl enable yearofbingo-backup.timer
  - systemctl enable yearofbingo-verify-backup.timer

  # Note: You must manually:
  # 1. Copy the tunnel credentials JSON to /home/deploy/.cloudflared/credentials.json
  #    Then run: sudo systemctl enable --now cloudflared
  # 2. Deploy the app via CI or manually copy compose.yaml and .env
  # 3. Update /home/deploy/.config/rclone/rclone.conf with your R2 credentials
  # 4. Add BACKUP_ENCRYPTION_KEY to /opt/yearofbingo/.env
  # 5. Create R2 bucket: yearofbingo-backups
  # 6. Start backup timer: sudo systemctl start yearofbingo-backup.timer
